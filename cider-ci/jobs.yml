jobs:
  Integration-Tests:
    run-on:
    - type: branch
      include-match: ^.*$

    context:

      script-defaults:
        environment-variables_process-templates: true
        environment-variables:
          DISPLAY: ":{{XVNC_PORT}}"
        timeout: 120

      task-defaults:
        # _cider-ci_include:
        #   - cider-ci/defaults/misc.yml
        #   - cider-ci/defaults/attachments.yml
        #   - cider-ci/defaults/traits.yml
        #   - cider-ci/defaults/ports.yml
        #   - cider-ci/defaults/scripts.yml

      tasks:
        integration:
          name: 'Integration Tests'

          traits:
            bash: true
            curl: true
            git: true
            leiningen: true
            linux: true
            maven: true
            maven3: true
            openjdk: true
            postgresql: true
            nodejs: true

          git-options:
            submodules:
              clone: True
              timeout: 60

          max-auto-trials: 1

          ports:
            XVNC_PORT:
              inet_address: "localhost"
              min: 5900
              max: 5999
            CI_SELENIUM_PORT:
              inet_address: "localhost"
              min: 9900
              max: 9999

          scripts:
            start-vnc:
              body: |
                #!/usr/bin/env bash
                set -eux
                tightvncserver "${DISPLAY}"  -geometry 1024x768 -rfbport "$XVNC_PORT"  -interface '0.0.0.0'

            npm_install:
              body: |
                #!/usr/bin/env bash
                npm install --no-spin && sleep 1
              start-when:
                - script: start-vnc

            run-selenium:
              body: |
                #!/usr/bin/env bash
                set -eux
                npm run selenium-standalone -- install
                npm run -s selenium-standalone -- start -- -port "${CI_SELENIUM_PORT}"
              ignore-state: true # we don't care about the exit status
              start-when:
                - script: npm_install

            test:
              name: 'Browser Integration Tests'
              body: |
                #!/usr/bin/env bash
                npm run -s integration-tests
              start-when:
              - script: run-selenium
                states: [executing]
