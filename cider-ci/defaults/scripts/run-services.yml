run-api: &run-service-default
  environment-variables:
    SERVICE_DIRECTORY: api
  body: |
    #!/usr/bin/env bash
    set -eux
    cd "$SERVICE_DIRECTORY"
    lein trampoline run
  start-when:
  - script: delay-service-bootstorm
  - script: create-database
  - script: create-rabbitmq-vhost
  terminate-when:
  - script: shutdown
    states: [aborted, passed, failed, skipped]

api-is-running: &is-running-default
  environment-variables:
    STATUS_URL: http://localhost:{{API_HTTP_PORT}}/
  body: |
    #!/usr/bin/env bash
    set -eux
    until curl --silent --fail -I "${STATUS_URL}";  do
      sleep 1;
    done
  start-when:
  - script: run-api
    states: [executing]
