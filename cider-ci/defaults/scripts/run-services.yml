run-api:
  environment-variables:
    SERVICE_DIRECTORY: api
  body: |
    #!/usr/bin/env bash
    set -eux
    cd "$API_SERVICE_PATH"
    lein trampoline run
  start-when:
  - script: create-database
  terminate-when:
  - script: shutdown
    states: [aborted, passed, failed, skipped]

api-is-running: 
  environment-variables:
    STATUS_URL: http://localhost:{{API_HTTP_PORT}}/
  body: |
    #!/usr/bin/env bash
    set -eux
    until curl --silent --fail -I "${STATUS_URL}";  do
      sleep 1;
    done
  start-when:
  - script: run-api
    states: [executing]
